name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package and pytest
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Verify import and entry point
        run: |
          python -c "import eval_unpacker as m; print('version:', getattr(m, '__version__', 'n/a'))"
          python - <<'PY'
import shutil
p = shutil.which('eval-unpack')
print('eval-unpack on PATH:', p)
if not p:
    raise SystemExit(1)
PY

      - name: CLI smoke test
        run: |
          mkdir -p examples
          echo "eval(function(p,a,c,k,e,d){return p}('abc',10,2,'a|b'))" > examples/sample_packed.js
          eval-unpack examples/sample_packed.js
          python -m eval_unpacker.cli examples/sample_packed.js

      - name: Run pytest if tests/ exists
        run: |
          if [ -d tests ]; then
            pytest -q
          else
            echo "No tests/; skipping."
          fi
