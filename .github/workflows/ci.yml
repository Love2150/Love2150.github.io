name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install (editable) + pytest
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -e .[beautify] || pip install -e .
          pip install pytest

      - name: Sanity: import + entry point
        run: |
          set -euxo pipefail
          python -c "import eval_unpacker, sys; print('version:', getattr(eval_unpacker, '__version__', 'n/a'))"
          python - <<'PY'
          import shutil
          p = shutil.which('eval-unpack')
          print('eval-unpack on PATH:', p)
          if not p:
              raise SystemExit(1)
          PY

      - name: Smoke test CLI
        run: |
          set -euxo pipefail
          mkdir -p examples
          echo "eval(function(p,a,c,k,e,d){return p}('abc',10,2,'a|b'))" > examples/sample_packed.js
          eval-unpack examples/sample_packed.js
          # Also ensure module invocation works
          python -m eval_unpacker.cli examples/sample_packed.js

      - name: Run pytest (if tests/ exists)
        run: |
          if [ -d tests ]; then
            pytest -q
          else
            echo "No tests/; skipping."
          fi

            pytest -q
          else
            echo "No tests/ directory; skipping pytest."
          fi
