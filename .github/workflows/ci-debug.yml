name: CI Debug
on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Show tree and key files
        continue-on-error: true
        run: |
          pwd
          find . -maxdepth 3 -type f | sort
          echo "----- pyproject.toml -----"
          sed -n '1,200p' pyproject.toml || true
          echo "----- eval_unpacker/ listing -----"
          ls -la eval_unpacker || true
          echo "----- README.md head -----"
          head -n 30 README.md || true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package (editable) + pytest
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip
          pip install -e . || true
          pip install pytest || true

      - name: Check import and CLI path
        continue-on-error: true
        run: |
          python -c "import eval_unpacker as m; print('import OK, version=', getattr(m,'__version__','n/a'))"
          python - <<'PY'
import shutil; print('which eval-unpack:', shutil.which('eval-unpack'))
PY

      - name: Smoke test (create sample & run both ways)
        continue-on-error: true
        run: |
          mkdir -p examples
          echo "eval(function(p,a,c,k,e,d){return p}('abc',10,2,'a|b'))" > examples/sample_packed.js
          echo "---- entry point ----"
          eval-unpack examples/sample_packed.js || echo "entry point failed"
          echo "---- module fallback ----"
          python -m eval_unpacker.cli examples/sample_packed.js || echo "module fallback failed"

      - name: Pytest if present
        continue-on-error: true
        run: |
          if [ -d tests ]; then
            pytest -q || echo "pytest failed"
          else
            echo "No tests/; skipping."
          fi
